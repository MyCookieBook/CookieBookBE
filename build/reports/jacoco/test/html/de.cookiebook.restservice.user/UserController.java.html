<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">rest-service</a> &gt; <a href="index.source.html" class="el_package">de.cookiebook.restservice.user</a> &gt; <span class="el_source">UserController.java</span></div><h1>UserController.java</h1><pre class="source lang-java linenums">package de.cookiebook.restservice.user;

import de.cookiebook.restservice.config.AuthenticationConfigConstants;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;
import java.sql.Timestamp;
import java.util.Date;
import java.util.List;

@RestController
<span class="fc" id="L15">@Slf4j</span>
@CrossOrigin(origins = &quot;http://localhost:4200&quot;)
public class UserController {
    @Autowired
    UserRepository userRepository;

<span class="fc" id="L21">    public UserController(UserRepository userRepository) {</span>
<span class="fc" id="L22">        this.userRepository = userRepository;</span>
<span class="fc" id="L23">    }</span>

    @PostMapping(&quot;/users/register&quot;)
    public long registerUser(@Valid @RequestBody User newUser) {
        try {
<span class="fc" id="L28">            List&lt;User&gt; users = userRepository.findAll();</span>
<span class="fc bfc" id="L29" title="All 2 branches covered.">            for (User user : users) {</span>
<span class="pc bpc" id="L30" title="1 of 2 branches missed.">                if ((user.getEmail()).equals(newUser.getEmail())) {</span>
<span class="nc" id="L31">                    System.out.println(&quot;User Already exists!&quot;);</span>
<span class="nc" id="L32">                    log.warn(Status.USER_ALREADY_EXISTS.toString());</span>
<span class="nc" id="L33">                    return Status.USER_ALREADY_EXISTS.getStatuscode();</span>
                }
<span class="fc" id="L35">            }</span>
<span class="fc" id="L36">            newUser.setDuration(new Date(System.currentTimeMillis() + AuthenticationConfigConstants.EXPIRATION_TIME));</span>
<span class="fc" id="L37">            userRepository.save(newUser);</span>
<span class="fc" id="L38">            log.info(Status.SUCCESS.toString());</span>
<span class="fc" id="L39">            log.info(String.valueOf(newUser.getId()));</span>
<span class="fc" id="L40">            return newUser.getId();</span>
<span class="nc" id="L41">        } catch (Exception e) {</span>
<span class="nc" id="L42">            log.error(&quot;failed register user&quot;);</span>
<span class="nc" id="L43">            log.error(e.getMessage());</span>
<span class="nc" id="L44">            return Status.FAILURE.getStatuscode();</span>
        }
    }

    @CrossOrigin(origins = &quot;http://localhost:4200/login&quot;)
    @PostMapping(&quot;/users/login&quot;)
    public long loginUser(@RequestParam(value = &quot;email&quot;) String email, @RequestParam(value = &quot;password&quot;) String password) {
<span class="fc" id="L51">        log.info(email);</span>
<span class="fc" id="L52">        log.info(password);</span>
        try {
<span class="fc" id="L54">            List&lt;User&gt; users = userRepository.findAll();</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">            for (User other : users) {</span>
<span class="pc bpc" id="L56" title="2 of 4 branches missed.">                if ((other.getEmail()).equals(email) &amp;&amp; (other.getPassword()).equals(password)) {</span>
<span class="fc" id="L57">                    log.info(String.valueOf(other.getId()));</span>
<span class="fc" id="L58">                    other.setLoggedIn(true);</span>
<span class="fc" id="L59">                    other.setDuration(new Date(System.currentTimeMillis() + AuthenticationConfigConstants.EXPIRATION_TIME));</span>
<span class="fc" id="L60">                    userRepository.save(other);</span>
<span class="fc" id="L61">                    return other.getId();</span>
                }
<span class="nc" id="L63">            }</span>
<span class="nc" id="L64">            log.error(String.valueOf(Status.FAILURE.getStatuscode()));</span>
<span class="nc" id="L65">            return Status.FAILURE.getStatuscode();</span>
<span class="nc" id="L66">        } catch (Exception e) {</span>
<span class="nc" id="L67">            log.error(&quot;failed log in user&quot;);</span>
<span class="nc" id="L68">            log.error(e.getMessage());</span>
<span class="nc" id="L69">            return Status.FAILURE.getStatuscode();</span>
        }
    }

    @PostMapping(&quot;/users/logout&quot;)
    public long logUserOut(@RequestParam(value = &quot;userId&quot;) long userId) {
<span class="fc" id="L75">        List&lt;User&gt; users = userRepository.findAll();</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        for (User other : users) {</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            if (other.getId() == userId) {</span>
<span class="fc" id="L78">                other.setLoggedIn(false);</span>
<span class="fc" id="L79">                other.setDuration(null);</span>
<span class="fc" id="L80">                userRepository.save(other);</span>
<span class="fc" id="L81">                return Status.SUCCESS.getStatuscode();</span>
            }
<span class="nc" id="L83">        }</span>
<span class="nc" id="L84">        return Status.FAILURE.getStatuscode();</span>
    }

    @GetMapping(&quot;/userlist&quot;)
    public List&lt;User&gt; getUsers() {
<span class="nc" id="L89">        return userRepository.findAll();</span>
    }

    @GetMapping(&quot;/user&quot;)
    public String[] getUser(@RequestParam(value = &quot;UserId&quot;) long userId) {
        try {
<span class="nc" id="L95">            String[] userArray = new String[2];</span>
<span class="nc" id="L96">            List&lt;User&gt; userlist = userRepository.findAll();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            for (User user : userlist) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (user.getId() == userId) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                    if (validateDurration(user)) {</span>
<span class="nc" id="L100">                        userArray[0] = user.getEmail();</span>
<span class="nc" id="L101">                        userArray[1] = user.getUsername();</span>
<span class="nc" id="L102">                        return userArray;</span>
                    } else {
<span class="nc" id="L104">                        return null;</span>
                    }
                }
<span class="nc" id="L107">            }</span>
<span class="nc" id="L108">            return null;</span>
<span class="nc" id="L109">        } catch (Exception e) {</span>
<span class="nc" id="L110">            log.error(e.getMessage());</span>
<span class="nc" id="L111">            return null;</span>
        }
    }

    public boolean validateDurration(User user) {
        try {
<span class="nc" id="L117">            Date expiration = user.getDuration();</span>
<span class="nc" id="L118">            Date time = new Timestamp(System.currentTimeMillis());</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (!time.before(expiration)) {</span>
<span class="nc" id="L120">                logUserOut(user.getId());</span>
<span class="nc" id="L121">                return false;</span>
            } else {
<span class="nc" id="L123">                return true;</span>
            }
<span class="nc" id="L125">        } catch (Exception e) {</span>
<span class="nc" id="L126">            log.error(e.getMessage());</span>
<span class="nc" id="L127">            return false;</span>
        }
    }

    // edit profile
    @PostMapping(&quot;/users/edit&quot;)
    public long editProfile(@Valid @RequestBody User user) {
        try {
<span class="nc" id="L135">            User userBefore = userRepository.findById(user.getId());</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (validateDurration(userBefore)) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if (user.getPassword() == null) {</span>
<span class="nc" id="L138">                    user.setPassword(userBefore.getPassword());</span>
                }
<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (user.getEmail() == null) {</span>
<span class="nc" id="L141">                    user.setEmail(userBefore.getEmail());</span>
                }
<span class="nc bnc" id="L143" title="All 2 branches missed.">                if (user.getUsername() == null) {</span>
<span class="nc" id="L144">                    user.setUsername(userBefore.getUsername());</span>
                }
<span class="nc" id="L146">                user.setLoggedIn(true);</span>
<span class="nc" id="L147">                user.setDuration(userBefore.getDuration());</span>
<span class="nc" id="L148">                userRepository.save(user);</span>
<span class="nc" id="L149">                System.out.println(user);</span>
<span class="nc" id="L150">                return Status.SUCCESS.getStatuscode();</span>
            } else {
<span class="nc" id="L152">                return Status.FAILURE.getStatuscode();</span>
            }

<span class="nc" id="L155">        } catch (Exception e) {</span>
<span class="nc" id="L156">            log.error(e.getMessage());</span>
<span class="nc" id="L157">            return Status.FAILURE.getStatuscode();</span>
        }
    }

    @PostMapping(&quot;/users/changePassword&quot;)
    public long changePassword(@Valid @RequestBody User user, @RequestParam(value = &quot;newPassword&quot;) String newPassword, HttpServletResponse response) {
        try {
<span class="nc" id="L164">            List&lt;User&gt; users = userRepository.findAll();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            for (User other : users) {</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">                if (other.getEmail().equals(user.getEmail()) &amp;&amp; other.getId() == user.getId()) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    if (validateDurration(other)) {</span>
<span class="nc" id="L168">                        user.setPassword(newPassword);</span>
<span class="nc" id="L169">                        user.setLoggedIn(true);</span>
<span class="nc" id="L170">                        user.setDuration(other.getDuration());</span>
<span class="nc" id="L171">                        userRepository.save(user);</span>
<span class="nc" id="L172">                        return Status.SUCCESS.getStatuscode();</span>
                    } else {
<span class="nc" id="L174">                        return Status.FAILURE.getStatuscode();</span>
                    }
                }
<span class="nc" id="L177">            }</span>
<span class="nc" id="L178">            response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L179">            return Status.FAILURE.getStatuscode();</span>

<span class="nc" id="L181">        } catch (Exception e) {</span>
<span class="nc" id="L182">            log.error(e.getMessage());</span>
<span class="nc" id="L183">            return Status.FAILURE.getStatuscode();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>